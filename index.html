<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Farm Monitor Pro | Multi-Farm</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --accent: #2ecc71;
            --bg: #f4f7f6; --text: #2c3e50; 
            --prev: #7f8c8d; --growth: #27ae60; --out: #e74c3c; 
            --warning: #f39c12; --partial: #3498db;
        }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex;
        background: var(--bg); color: var(--text); overflow: hidden; }
        
        #map { flex-grow: 1; height: 100%; background: #000; position: relative; } 
        #sidebar { width: 380px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; box-shadow: -2px 0 5px rgba(0,0,0,0.1); z-index: 1000; }
        
        .header { padding: 20px; background: #fff; border-bottom: 1px solid #eee; }
        
        .mode-toggle-container { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;}
        .mode-btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: #f9f9f9; cursor: pointer; border-radius: 6px; font-size: 11px; font-weight: bold; color: #777; transition: 0.2s; white-space: nowrap; }
        .mode-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Farm Selector Styles */
        .farm-selector { display: none; gap: 8px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #eee; }
        .farm-btn { flex: 1; padding: 8px; border: 2px solid #eee; background: white; cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: 800; color: #95a5a6; text-transform: uppercase; transition: 0.2s; }
        .farm-btn:hover { border-color: var(--accent); color: var(--accent); }
        .farm-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .avg-box { background: var(--accent); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 5px; }
        .avg-row { display: flex; justify-content: space-around; align-items: center; }
        .sync-note { font-size: 10px; color: #95a5a6; text-align: center; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        #list { flex-grow: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; }
        .card { background: white; border: 1px solid #eee; padding: 14px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; border-left: 5px solid #ccc; position: relative; transition: 0.2s; }
        .card:hover { background: #fafafa; }
        .card.active { border-left-color: var(--accent); background: #f0fff4; border-right: 1px solid var(--accent); }
        .card.is-out { opacity: 0.8; border-left-color: var(--out); }
        .card.is-partial { border-left-color: var(--partial); background: #f0f7ff; }

        .val { font-size: 17px; font-weight: bold; color: var(--accent); }
        .val.prev { color: var(--prev); font-size: 14px; }
        .unit { font-size: 10px; color: #95a5a6; font-weight: normal; margin-left: 2px; }
        .label { font-size: 10px; text-transform: uppercase; color: #95a5a6; font-weight: bold; display: block; }

        .map-controls { position: absolute; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .layer-group { background: white; padding: 4px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: flex; }
        .layer-btn { padding: 8px 15px; border: none; background: none; cursor: pointer; font-size: 11px; font-weight: bold; color: #777; border-radius: 6px; transition: 0.2s; }
        .layer-btn.active { background: var(--accent); color: white; }
        .date-label { background: rgba(0,0,0,0.7); color: white; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }

        .legend-box { background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 180px; display: none; }
        .legend-item { display: flex; align-items: center; font-size: 11px; margin-bottom: 5px; color: #555; font-weight: 600; }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; margin-right: 10px; border: 1px solid rgba(0,0,0,0.1); }

        .paddock-label { background: rgba(255, 255, 255, 0.95) !important; border: 1px solid #333 !important; padding: 4px 8px !important; border-radius: 4px !important; pointer-events: none !important; color: #000 !important; opacity: 0 !important; transition: opacity 0.2s ease-in-out !important; text-align: center !important; line-height: 1.2 !important; }
        .paddock-label.show-label { opacity: 1 !important; }

        .badge { color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px; vertical-align: middle; text-transform: uppercase; }
        #search { width:100%; padding:12px; border-radius:6px; border:1px solid #ddd; outline:none; box-sizing: border-box; }
        .fallback-alert { color: var(--warning); font-size: 10px; font-weight: bold; margin-bottom: 5px; display: block; }

        .calib-box { margin-top: 8px; background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 10px; font-size: 11px; color: #7f8c8d; }
        .calib-row { display:flex; justify-content:space-between; align-items:center; gap:10px; }
        .calib-pill { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 10px; font-weight: 700; letter-spacing: 0.3px; color: white; background: var(--prev); text-transform: uppercase; white-space: nowrap; }
        .calib-pill.good { background: var(--accent); }
        .calib-pill.warn { background: var(--warning); }
        .calib-pill.bad { background: var(--out); }

        .manual-chip { display:inline-block; margin-top: 6px; padding: 4px 8px; border-radius: 6px; border: 1px solid #dff3e7; background: #f0fff4; font-size: 10px; color: #2c3e50; }
        .manual-chip.bad { background: #fff5f5; border-color: #ffd8d8; }
        .manual-chip b { color: var(--growth); }
        .manual-chip.bad b { color: var(--out); }
        .manual-chip .muted { color:#95a5a6; font-weight:600; }

        /* Feed Calculations View */
        #feed-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #f4f7f6; z-index: 2000; display: none; flex-direction: column;
            overflow-y: auto; padding: 20px; box-sizing: border-box;
        }
        .feed-container { max-width: 1000px; margin: 0 auto; width: 100%; }
        .feed-card { background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        .feed-title-row { display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .feed-title { font-size: 18px; font-weight: 700; color: var(--text); }
        
        .calc-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 11px; text-transform: uppercase; color: #7f8c8d; font-weight: bold; margin-bottom: 4px; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-weight: bold; color: var(--text); box-sizing: border-box; }
        .input-group input:focus { border-color: var(--accent); outline: none; }
        .input-group .ro-val { padding: 8px; background: #f8f9fa; border: 1px solid #eee; border-radius: 5px; font-weight: bold; color: #2c3e50; }
        
        .result-highlight { background: #f0fff4; border: 1px solid var(--accent); padding: 15px; border-radius: 8px; text-align: center; }
        .result-highlight h3 { margin: 0; font-size: 24px; color: var(--accent); }
        .result-highlight small { text-transform: uppercase; font-size: 10px; color: #7f8c8d; font-weight: bold; }

        .chart-box { height: 350px; width: 100%; position: relative; }

        .btn-save { padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-weight: bold; font-size: 11px; cursor: pointer; }
        .btn-save:hover { background: #2c3e50; }
        .save-status { font-size: 11px; color: var(--growth); font-weight: bold; margin-right: 10px; display: none; }
    </style>
</head>
<body>

<div id="map">
    <div class="map-controls">
        <div id="latest-date" class="date-label">LATEST DATA: --</div>
        <div id="sat-layer-controls" class="layer-group">
            <button id="btn-ndvi" class="layer-btn active" onclick="setLayerMode('ndvi')">NDVI SATELLITE</button>
            <button id="btn-cover" class="layer-btn" onclick="setLayerMode('cover')">COVER MAP</button>
        </div>
        <div id="legend" class="legend-box">
            <div style="font-size: 9px; color: #999; margin-bottom: 8px; text-transform: uppercase;">Cover Scale (kgDM/ha)</div>
            <div class="legend-item"><div class="legend-color" style="background:#00441b"></div> > 2,800</div>
            <div class="legend-item"><div class="legend-color" style="background:#238b45"></div> 2,000 - 2,400</div>
            <div class="legend-item"><div class="legend-color" style="background:#a1d99b"></div> < 1,600</div>
            <hr style="border:0; border-top:1px solid #eee; margin:8px 0;">
            <div class="legend-item"><div class="legend-color" style="background:#3498db"></div> Partial Grazed</div>
            <div class="legend-item"><div class="legend-color" style="background:#ff7675"></div> Out of Rotation</div>
        </div>
    </div>

    <div id="feed-view">
        <div class="feed-container">
            
            <div class="feed-card">
                <div class="feed-title">Feed Wedge & Demand</div>
                <div class="chart-box">
                    <canvas id="wedgeChart"></canvas>
                </div>
            </div>

            <div class="feed-card">
                <div class="feed-title-row">
                    <div class="feed-title">Rotation Parameters</div>
                    <div>
                        <span id="save-msg" class="save-status">SAVED TO CLOUD!</span>
                        <button class="btn-save" onclick="saveToCloud()">SAVE TO CLOUD</button>
                    </div>
                </div>
                <div class="calc-grid">
                    <div class="input-group">
                        <label>Total Area (Rotation)</label>
                        <div id="feed-area-total" class="ro-val">0</div>
                    </div>
                    <div class="input-group">
                        <label>Farm Avg Cover</label>
                        <div id="feed-avg-cover" class="ro-val">0</div>
                    </div>
                    <div class="input-group">
                        <label>Farm Avg Growth</label>
                        <div id="feed-avg-growth" class="ro-val">0</div>
                    </div>
                    <div class="input-group">
                        <label>Post Grazing Residual</label>
                        <input type="number" id="inp-residual" value="1500" oninput="saveAndRecalc()">
                    </div>
                </div>
                <div class="calc-grid" style="margin-top:15px;">
                    <div class="input-group">
                        <label>Number of Cows</label>
                        <input type="number" id="inp-cows" value="500" oninput="saveAndRecalc()">
                    </div>
                    <div class="input-group">
                        <label>Avg Daily Intake (kgDM/cow)</label>
                        <input type="number" id="inp-intake" value="18" oninput="saveAndRecalc()">
                    </div>
                    <div class="input-group">
                        <label>Rotation Length (days)</label>
                        <input type="number" id="inp-round" value="25" oninput="saveAndRecalc()">
                    </div>
                </div>
            </div>

            <div class="feed-card">
                <div class="feed-title">Allocation & Targets</div>
                <div class="calc-grid">
                    <div class="result-highlight">
                        <h3 id="res-target-pre">0</h3>
                        <small>Calculated Pre-graze Target</small>
                    </div>
                    <div class="result-highlight">
                        <h3 id="res-area-day">0</h3>
                        <small>Area Available (ha/day)</small>
                    </div>
                    <div class="result-highlight">
                        <h3 id="res-area-cow">0</h3>
                        <small>Area per Cow (m²/day)</small>
                    </div>
                </div>
            </div>

            <div class="feed-card">
                <div class="feed-title">Supplement Calculator</div>
                <div class="calc-grid">
                    <div class="input-group">
                        <label>Calc. Pre-graze Target</label>
                        <div id="feed-target-copy" class="ro-val">0</div>
                    </div>
                    <div class="input-group">
                        <label>Actual Pre-grazing Cover (User)</label>
                        <input type="number" id="inp-actual-pre" value="2800" oninput="saveAndRecalc()">
                    </div>
                    <div class="result-highlight" style="border-color:var(--warning); background:#fffaf0;">
                        <h3 id="res-supp" style="color:var(--warning)">0</h3>
                        <small>Supplement Required (kg/cow/day)</small>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="sidebar">
    <div class="header">
        <div class="mode-toggle-container">
            <button id="btn-mode-sat" class="mode-btn" onclick="switchDashboardMode('satellite')">SATELLITE MODE</button>
            <button id="btn-mode-man" class="mode-btn active" onclick="switchDashboardMode('manual')">MANUAL FARMWALK</button>
            <button id="btn-mode-feed" class="mode-btn" onclick="switchDashboardMode('feed')">FEED WEDGE</button>
        </div>

        <div id="farm-toggle" class="farm-selector">
            <button id="btn-wai" class="farm-btn active" onclick="switchFarm('wainono')">WAINONO</button>
            <button id="btn-tr" class="farm-btn" onclick="switchFarm('teruahete')">TE RUAHETE</button>
        </div>

        <div id="fallback-warning" class="fallback-alert" style="display:none;">⚠️ RECENT DATA LOW (UNDER 0.3) - SHOWING PREVIOUS DATE</div>
        
        <div id="calibration-box" class="calib-box" style="display:none;">
            <div class="calib-row" id="calib-hover-area">
                <div style="font-weight:800; color:#2c3e50; font-size:10px; text-transform:uppercase;">FARMWALK CALIBRATION CONFIDENCE</div>
                <span id="calib-pill" class="calib-pill">...</span>
            </div>
            <div id="calib-text" style="margin-top:6px; line-height:1.35; display:none;">--</div>
        </div>

        <div class="avg-box">
            <div class="avg-row">
                <div class="avg-item"><small>FARM AVG COVER</small><div id="total-avg" style="font-size: 22px; font-weight: bold;">0</div><small>kgDM/ha</small></div>
                <div class="avg-item"><small>GROWTH</small><div id="avg-growth" style="font-size: 22px; font-weight: bold;">0</div><small>kg/day</small></div>
            </div>
        </div>
        <div class="sync-note">Synchronized on <span id="sync-time">...</span></div>
        <input type="text" id="search" placeholder="Search paddocks...">
    </div>
    <div id="list">Loading data...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* === CONFIGURATION === */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwu-gm4MizN_14NZCRN7DxD-jpq1IiKSY-5t_AuIV2eGHdRz9BXky-tHPd4WZlAqA42Ug/exec"; 

/* SHARED SOURCES */
const MANUAL_CALIBRATION_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRBBRftvApfrkHKVQh9FV1qsYVy3Y2whaHKfyAWJ5Ymbc1cTcw7IzB4epF8h_-rN1dxD-N7bdaJyp1V/pub?gid=2878588&single=true&output=csv";
const SATELLITE_DATA_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRBBRftvApfrkHKVQh9FV1qsYVy3Y2whaHKfyAWJ5Ymbc1cTcw7IzB4epF8h_-rN1dxD-N7bdaJyp1V/pub?gid=1426555702&single=true&output=csv";

const FARM_CONFIG = {
    wainono: {
        center: [-44.118829, 170.8550364],
        geojson: "https://storage.googleapis.com/ndvi-exports/wainono.geojson",
        exclusions_csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRBBRftvApfrkHKVQh9FV1qsYVy3Y2whaHKfyAWJ5Ymbc1cTcw7IzB4epF8h_-rN1dxD-N7bdaJyp1V/pub?gid=653318078&single=true&output=csv",
        manual_mode_csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRBBRftvApfrkHKVQh9FV1qsYVy3Y2whaHKfyAWJ5Ymbc1cTcw7IzB4epF8h_-rN1dxD-N7bdaJyp1V/pub?gid=1312869086&single=true&output=csv",
        feed_settings_csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1OhQkUXzp_TuFwnePsBSp2XlHE7Pw165eReEsOUyLwSldUuvviIdx-M8j0bbII2SYc7trwpjfM6aA/pub?gid=605870127&single=true&output=csv",
        partial_csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRBBRftvApfrkHKVQh9FV1qsYVy3Y2whaHKfyAWJ5Ymbc1cTcw7IzB4epF8h_-rN1dxD-N7bdaJyp1V/pub?gid=71697510&single=true&output=csv"
    },
    teruahete: {
        center: [-44.150000, 170.800000],
        geojson: "https://storage.googleapis.com/ndvi-exports/wainono.geojson", // Placeholder
        exclusions_csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRBBRftvApfrkHKVQh9FV1qsYVy3Y2whaHKfyAWJ5Ymbc1cTcw7IzB4epF8h_-rN1dxD-N7bdaJyp1V/pub?gid=729706976&single=true&output=csv",
        manual_mode_csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRBBRftvApfrkHKVQh9FV1qsYVy3Y2whaHKfyAWJ5Ymbc1cTcw7IzB4epF8h_-rN1dxD-N7bdaJyp1V/pub?gid=1312869086&single=true&output=csv", // Placeholder
        feed_settings_csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1OhQkUXzp_TuFwnePsBSp2XlHE7Pw165eReEsOUyLwSldUuvviIdx-M8j0bbII2SYc7trwpjfM6aA/pub?gid=605870127&single=true&output=csv", // Placeholder
        partial_csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRBBRftvApfrkHKVQh9FV1qsYVy3Y2whaHKfyAWJ5Ymbc1cTcw7IzB4epF8h_-rN1dxD-N7bdaJyp1V/pub?gid=71697510&single=true&output=csv" // Placeholder
    }
};

/* State */
let currentFarmId = 'wainono';
let map, ndviLayer, geoLayer, baseLayer;
let satellitePaddockData = [];
let manualModeData = [];      
let paddockMap = {};
let areaLookup = {}; 
let excludedPaddocks = new Map(); 
let partialPaddocks = new Set();
let currentViewMode = 'ndvi';   
let currentDashboardMode = 'manual';
let globalCalibrationModel = null;
let satelliteHistory = {};
let wedgeChartInstance = null;

/* Helpers */
function normName(s){ return (s||"").trim().toLowerCase(); }
function parseStrangeDate(dateStr) {
    if (!dateStr) return null;
    const s = (""+dateStr).trim();
    if (s === "") return null;
    try {
        if (!isNaN(s) && s.length > 5) {
            const d = new Date((parseFloat(s) - 25569) * 86400 * 1000);
            return isNaN(d) ? null : d;
        }
    } catch(e){}
    if (s.includes('/')) {
        const parts = s.split('/');
        if (parts.length === 3) {
            const d = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            return isNaN(d) ? null : d;
        }
    }
    const d = new Date(s);
    return isNaN(d) ? null : d;
}
function fmtNZ(dateObj){ return dateObj ? dateObj.toLocaleDateString('en-NZ', { month: 'short', day: 'numeric' }) : ""; }
function safeNum(x){
    const s = (""+x).replace(/,/g,'').trim();
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
}

/* 1. CALCULATE GLOBAL CALIBRATION (Te Ruahete Only) */
async function calculateGlobalCalibration() {
    try {
        const [resMan, resSat, resTrEx] = await Promise.all([
            fetch(MANUAL_CALIBRATION_CSV + "&t=" + Date.now()),
            fetch(SATELLITE_DATA_CSV + "&t=" + Date.now()),
            fetch(FARM_CONFIG['teruahete'].exclusions_csv + "&t=" + Date.now())
        ]);
        
        const txtMan = await resMan.text();
        const txtSat = await resSat.text();
        const txtTrEx = await resTrEx.text();
        
        // 1. Identify Te Ruahete Paddocks (Anything in the TR Exclusion list)
        const trPaddocks = new Set();
        txtTrEx.split('\n').forEach(l => {
            const n = l.split(',')[0].trim();
            if(n) trPaddocks.add(normName(n));
        });

        const satData = {};
        const manualPoints = [];

        // 2. Parse Shared Satellite Data
        Papa.parse(txtSat, { header:true, skipEmptyLines:true, complete: (res) => {
            res.data.forEach(r => {
                const n = r.paddock_name; 
                const d = parseStrangeDate(r.date);
                if(n && d) {
                    if(!satData[normName(n)]) satData[normName(n)] = [];
                    satData[normName(n)].push({ 
                        date: d, 
                        ndvi: parseFloat(r.ndvi_mean || r.ndvi_effective),
                        cloud: parseFloat(r.cloud_pc)||0 
                    });
                }
            });
        }});

        // 3. Parse Manual Data & Filter for Te Ruahete Only
        Papa.parse(txtMan, { header:true, skipEmptyLines:true, complete: (res) => {
            const f = res.meta.fields.map(s => s.toLowerCase());
            const idxN = f.findIndex(s => s.includes('paddock'));
            const idxD = f.findIndex(s => s.includes('date'));
            const idxC = f.findIndex(s => s.includes('measured') || s.includes('manual') || s.includes('cover'));
            
            res.data.forEach(r => {
                const n = r[res.meta.fields[idxN]];
                const d = parseStrangeDate(r[res.meta.fields[idxD]]);
                const c = safeNum(r[res.meta.fields[idxC]]);
                if(n && d && c > 0 && trPaddocks.has(normName(n))) {
                    manualPoints.push({ name: normName(n), date: d, cover: c });
                }
            });
        }});

        // 4. Build Regression (Wait for parse)
        setTimeout(() => {
            const pairs = [];
            const growthRate = 40; 
            manualPoints.forEach(m => {
                const hist = satData[m.name];
                if(hist && hist.length > 0) {
                    const sorted = hist.sort((a,b) => Math.abs(a.date - m.date) - Math.abs(b.date - m.date));
                    const match = sorted[0];
                    const diff = Math.abs((match.date - m.date)/86400000);
                    if(diff <= 5) {
                        const satVal = 331.62 * Math.exp(2.4555 * match.ndvi);
                        const manualProj = m.cover - (growthRate * (match.date < m.date ? -diff : diff)); 
                        if(satVal > 0 && manualProj > 0) {
                            pairs.push({ x: satVal, y: manualProj });
                        }
                    }
                }
            });

            if(pairs.length > 3) {
                const n = pairs.length;
                const meanX = pairs.reduce((a,b)=>a+b.x,0)/n;
                const meanY = pairs.reduce((a,b)=>a+b.y,0)/n;
                let num=0, den=0;
                pairs.forEach(p => { num += (p.x-meanX)*(p.y-meanY); den += (p.x-meanX)**2; });
                const slope = den!==0 ? num/den : 1;
                const intercept = meanY - slope*meanX;
                
                let ssTot=0, ssRes=0;
                pairs.forEach(p => {
                    const pred = slope*p.x + intercept;
                    ssTot += (p.y-meanY)**2;
                    ssRes += (p.y-pred)**2;
                });
                const r2 = ssTot!==0 ? (1 - ssRes/ssTot) : 0;

                globalCalibrationModel = { slope, intercept, r2, count: n };
                updateCalibrationUI();
                
                // If dashboard is already showing uncalibrated data, reload it
                if(satellitePaddockData.length > 0) processSatelliteData();
            }
        }, 500);

    } catch(e) { console.error("Calib error", e); }
}

function updateCalibrationUI(){
    const box = document.getElementById('calibration-box');
    if(!globalCalibrationModel) return;
    
    if(currentDashboardMode === 'satellite') box.style.display = 'block';
    
    const m = globalCalibrationModel;
    let cls = 'bad'; let txt = 'WEAK';
    if(m.r2 > 0.7) { cls='good'; txt='GOOD'; }
    else if(m.r2 > 0.5) { cls='warn'; txt='LOW'; }

    document.getElementById('calib-pill').className = `calib-pill ${cls}`;
    document.getElementById('calib-pill').innerText = txt;
    document.getElementById('calib-text').innerHTML = 
        `<b>R²:</b> ${m.r2.toFixed(2)} | <b>pts:</b> ${m.count}<br>y = ${m.slope.toFixed(2)}x + ${Math.round(m.intercept)}`;
}

/* 2. LOAD FARM DATA */
async function loadFarmData(farmId) {
    document.getElementById('list').innerHTML = "Loading " + farmId + "...";
    currentFarmId = farmId;
    
    // UI Update
    document.getElementById('btn-wai').classList.toggle('active', farmId==='wainono');
    document.getElementById('btn-tr').classList.toggle('active', farmId==='teruahete');

    // 1. Load Settings
    await loadFeedSettings();
    
    // 2. Load Exclusions (Critical for defining farm scope)
    await loadStatusSheets();
    
    // 3. Load GeoJSON
    await loadGeoJSON(); 
    
    // 4. Process Shared Satellite Data for THIS farm
    if(Object.keys(satelliteHistory).length > 0) {
        processSatelliteData();
    } else {
        await loadSharedSatelliteData();
    }
    
    if(currentDashboardMode === 'manual') await loadManualRankCSV();
    
    renderDashboard();
}

async function loadStatusSheets() {
    try {
        const [resEx, resPa] = await Promise.all([
            fetch(FARM_CONFIG[currentFarmId].exclusions_csv + "&t=" + Date.now()),
            fetch(FARM_CONFIG[currentFarmId].partial_csv + "&t=" + Date.now())
        ]);
        const txtEx = await resEx.text();
        
        excludedPaddocks = new Map();
        // Store 'out' status. If present but not 'out', we still know it belongs to farm
        txtEx.split('\n').slice(1).forEach(l => {
            const c = l.split(',');
            if(c[0]) excludedPaddocks.set(normName(c[0]), c[1] || 'active');
        });
        
        const txtPa = await resPa.text();
        partialPaddocks = new Set();
        txtPa.split('\n').forEach(l => {
            if(l.trim()) partialPaddocks.add(normName(l.split(',')[0]));
        });
    } catch(e){}
}

async function loadGeoJSON() {
    try {
        if(geoLayer) map.removeLayer(geoLayer);
        const res = await fetch(FARM_CONFIG[currentFarmId].geojson);
        const data = await res.json();
        
        areaLookup = {};
        data.features.forEach(f => {
            if(f.properties.name) areaLookup[normName(f.properties.name)] = f.properties.calcArea || 0;
        });

        geoLayer = L.geoJSON(data, {
            style: { color: 'white', weight: 1.5, fillOpacity: 0.1 },
            onEachFeature: (f, l) => {
                const n = f.properties.name;
                paddockMap[n] = l;
                l.on('click', () => {
                    const p = getCurrentModeData().find(x => x.name === n);
                    const col = (p && !p.isOut) ? (p.isPartial ? 'var(--partial)' : 'var(--accent)') : '#e74c3c';
                    focusPaddockOnMap(n, col);
                    const card = document.getElementById('card-'+n.replace(/\s/g,'-'));
                    if(card) card.scrollIntoView({behavior:'smooth', block:'center'});
                });
            }
        }).addTo(map);
        map.fitBounds(geoLayer.getBounds());
    } catch(e){}
}

async function loadSharedSatelliteData() {
    try {
        const res = await fetch(SATELLITE_DATA_CSV + "&t=" + Date.now());
        const txt = await res.text();
        
        const grouped = {};
        let latestDateStr = "";
        
        Papa.parse(txt, { header:true, skipEmptyLines:true, complete: (r) => {
            r.data.forEach(row => {
                const n = row.paddock_name; if(!n) return;
                const d = parseStrangeDate(row.date); if(!d) return;
                
                if(!grouped[n]) grouped[n] = [];
                grouped[n].push({
                    name: n,
                    date: d,
                    ndvi: parseFloat(row.ndvi_mean || row.ndvi_effective),
                    cloud: parseFloat(row.cloud_pc)||0,
                    url: (row['latest-update'] || row.map_id || "").replace(/['"]+/g, '')
                });
            });

            // Find global latest date
            const allDates = new Set();
            Object.values(grouped).forEach(g => g.forEach(x => allDates.add(x.date.getTime())));
            const sortedDates = Array.from(allDates).sort((a,b)=>b-a);
            if(sortedDates[0]) latestDateStr = fmtNZ(new Date(sortedDates[0]));
            
            document.getElementById('latest-date').innerText = "LATEST: " + latestDateStr;

            // Sort histories
            satelliteHistory = {};
            Object.keys(grouped).forEach(name => {
                satelliteHistory[name] = grouped[name].sort((a,b)=>b.date - a.date);
            });
            
            processSatelliteData();
        }});
    } catch(e){}
}

function processSatelliteData() {
    satellitePaddockData = [];
    
    // Iterate ALL satellite history
    Object.keys(satelliteHistory).forEach(name => {
        const nNorm = normName(name);

        // FILTER: Only include paddocks that exist in current farm's exclusion list
        // (This acts as the master list of paddocks for the farm)
        if(!excludedPaddocks.has(nNorm)) return;

        const hist = satelliteHistory[name];
        const latest = hist[0];
        const prev = hist[1]; 
        
        // Calc Cover (Calibration or Raw)
        let cover = 0;
        let raw = 331.62 * Math.exp(2.4555 * latest.ndvi);
        
        if(globalCalibrationModel) {
            cover = Math.round(globalCalibrationModel.slope * raw + globalCalibrationModel.intercept);
        } else {
            cover = Math.round(raw);
        }
        if(latest.cloud > 20) cover = 0; // Simple cloud mask
        
        // Calc Growth (Farm Specific)
        let growth = 0;
        if(prev) {
            let prevRaw = 331.62 * Math.exp(2.4555 * prev.ndvi);
            let prevCover = globalCalibrationModel ? (globalCalibrationModel.slope*prevRaw + globalCalibrationModel.intercept) : prevRaw;
            const days = (latest.date - prev.date)/86400000;
            if(days > 0) growth = Math.round((cover - prevCover)/days);
        }

        const status = excludedPaddocks.get(nNorm);
        const isOut = (status === 'out');
        
        satellitePaddockData.push({
            name: name,
            latest: { cover: Math.max(0, cover), formattedDate: fmtNZ(latest.date), url: latest.url },
            growthRate: Math.max(0, growth),
            area: areaLookup[nNorm] || 0,
            isOut: isOut,
            isPartial: partialPaddocks.has(nNorm)
        });
    });

    // Map Tile
    const top = satellitePaddockData.find(p => p.latest.url && !p.isOut);
    if(top && currentViewMode==='ndvi') updateMapTile(top.latest.url);

    if(currentDashboardMode === 'satellite') renderDashboard();
}

/* UI & Logic */
function switchFarm(id) {
    if(currentFarmId === id) return;
    loadFarmData(id);
}

function switchDashboardMode(mode) {
    currentDashboardMode = mode;
    document.getElementById('btn-mode-sat').classList.toggle('active', mode==='satellite');
    document.getElementById('btn-mode-man').classList.toggle('active', mode==='manual');
    document.getElementById('btn-mode-feed').classList.toggle('active', mode==='feed');

    const isSat = (mode === 'satellite');
    document.getElementById('farm-toggle').style.display = isSat ? 'flex' : 'none';
    document.getElementById('calibration-box').style.display = isSat ? 'block' : 'none';
    document.getElementById('sat-layer-controls').style.display = isSat ? 'flex' : 'none';
    document.getElementById('feed-view').style.display = (mode==='feed') ? 'flex' : 'none';

    if(isSat) {
        setLayerMode('ndvi');
        updateCalibrationUI(); // Ensure visible
        // If data empty, load default
        if(satellitePaddockData.length === 0) loadFarmData(currentFarmId);
    } else if(mode === 'manual') {
        setLayerMode('cover');
        if(manualModeData.length === 0) loadManualRankCSV();
    } else {
        calculateFeedLogic();
    }
    renderDashboard();
}

function renderDashboard() {
    const data = getCurrentModeData();
    const list = document.getElementById('list');
    list.innerHTML = "";
    
    // Calculate Stats (AVG COVER & GROWTH)
    let totArea=0, wCover=0, wGrowth=0;
    
    data.forEach(p => {
        if(!p.isOut && p.area > 0) {
            totArea += p.area;
            wCover += (p.latest.cover * p.area);
            wGrowth += (p.growthRate * p.area);
        }
    });
    
    const avgCov = totArea ? Math.round(wCover/totArea) : 0;
    const avgGro = totArea ? Math.round(wGrowth/totArea) : 0;
    
    document.getElementById('total-avg').innerText = avgCov;
    document.getElementById('avg-growth').innerText = avgGro;
    document.getElementById('feed-avg-cover').innerText = avgCov;
    document.getElementById('feed-avg-growth').innerText = avgGro;
    document.getElementById('feed-area-total').innerText = totArea.toFixed(1);

    // Render Cards
    data.sort((a,b) => (a.isOut===b.isOut) ? b.latest.cover - a.latest.cover : (a.isOut?1:-1));
    
    data.forEach(p => {
        const div = document.createElement('div');
        div.className = `card ${p.isOut?'is-out':''} ${p.isPartial?'is-partial':''}`;
        div.id = `card-${p.name.replace(/\s/g,'-')}`;
        div.innerHTML = `
            <div style="display:flex;justify-content:space-between"><b>${p.name}</b> <small>${p.area.toFixed(1)}ha</small></div>
            <div style="display:flex;justify-content:space-between;margin-top:5px">
                <span class="val" style="color:${p.isOut?'var(--out)':'var(--accent)'}">${p.latest.cover} <small class="unit">kgDM</small></span>
                ${(p.growthRate && !p.isOut) ? `<span style="color:var(--growth);font-weight:bold">+${p.growthRate}</span>` : ''}
            </div>
            <div style="font-size:10px;color:#999;margin-top:2px">${p.latest.formattedDate}</div>
        `;
        div.onclick = () => {
            focusPaddockOnMap(p.name, 'var(--accent)');
            if(currentDashboardMode==='satellite' && p.latest.url) updateMapTile(p.latest.url);
        };
        list.appendChild(div);
    });
    
    updateGeoStyles();
}

function updateGeoStyles() {
    if(!geoLayer) return;
    const data = getCurrentModeData();
    geoLayer.eachLayer(l => {
        const n = l.feature.properties.name;
        const p = data.find(x => x.name === n);
        if(p) {
            let col = '#a1d99b';
            if(p.latest.cover > 2800) col = '#00441b';
            else if(p.latest.cover > 2400) col = '#006d2c';
            else if(p.latest.cover > 2000) col = '#238b45';
            else if(p.latest.cover > 1600) col = '#41ab5d';
            
            if(p.isOut) col = '#e74c3c';
            else if(p.isPartial) col = '#3498db';
            
            const isCoverMode = (currentDashboardMode !== 'satellite' || currentViewMode === 'cover');
            
            l.setStyle({ 
                fillColor: col, 
                fillOpacity: isCoverMode ? 0.6 : 0.0, 
                color: 'white', 
                weight: isCoverMode ? 1 : 2 
            });
            l.bindTooltip(`${n}: ${p.latest.cover}kg`);
        }
    });
}

function setLayerMode(m) {
    currentViewMode = m;
    if(ndviLayer) {
        if(m==='ndvi') ndviLayer.addTo(map);
        else map.removeLayer(ndviLayer);
    }
    updateGeoStyles();
}

function updateMapTile(url) {
    if(!url) return;
    if(ndviLayer) map.removeLayer(ndviLayer);
    ndviLayer = L.tileLayer(url, { opacity: 1, maxZoom: 22 }).addTo(map);
}

function focusPaddockOnMap(n, c) {
    if(paddockMap[n]) {
        map.fitBounds(paddockMap[n].getBounds());
        paddockMap[n].setStyle({ color: 'yellow', weight: 4 });
    }
}

// Init Sequence
calculateGlobalCalibration();
loadFarmData('wainono');

// Helper logic for Manual/Feed modes (from original script)
async function loadManualRankCSV() {
    try {
        const res = await fetch(FARM_CONFIG[currentFarmId].manual_mode_csv + "&t=" + Date.now());
        const txt = await res.text();
        Papa.parse(txt, { header: false, complete: (r) => {
            const rows = r.data || [];
            if(rows.length < 1) return;
            const d1 = parseStrangeDate(rows[0][1]);
            const d2 = parseStrangeDate(rows[0][2]);
            const diff = (d1 && d2) ? (d1-d2)/86400000 : 1;
            
            manualModeData = rows.slice(1).map(row => {
               const n = (row[0]||"").trim();
               const cov = safeNum(row[1]);
               const prev = safeNum(row[2]);
               const isOut = (cov===0);
               return {
                   name: n,
                   latest: { cover: cov, formattedDate: fmtNZ(d1) },
                   growthRate: isOut ? 0 : Math.round((cov-prev)/diff),
                   area: areaLookup[normName(n)] || 0,
                   isOut: isOut
               }; 
            });
            if(currentDashboardMode==='manual') renderDashboard();
        }});
    } catch(e){}
}
function calculateFeedLogic() { 
    // Inputs
    const residual = safeNum(document.getElementById('inp-residual').value);
    const cows = safeNum(document.getElementById('inp-cows').value);
    const intake = safeNum(document.getElementById('inp-intake').value);
    const round = safeNum(document.getElementById('inp-round').value);
    const totalArea = safeNum(document.getElementById('feed-area-total').innerText);
    const actualPre = safeNum(document.getElementById('inp-actual-pre').value);

    // Pre-grazing Target
    let preGrazeTarget = 0;
    if (totalArea > 0) {
        preGrazeTarget = ((cows * intake * round) / totalArea) + residual;
    }
    document.getElementById('res-target-pre').innerText = Math.round(preGrazeTarget);
    document.getElementById('feed-target-copy').innerText = Math.round(preGrazeTarget);

    // Area available per day
    let areaDay = 0;
    if (round > 0) areaDay = totalArea / round;
    document.getElementById('res-area-day').innerText = areaDay.toFixed(2);

    // Area available per day per cow (m2)
    let areaCow = 0;
    if (cows > 0) areaCow = (areaDay / cows) * 10000;
    document.getElementById('res-area-cow').innerText = Math.round(areaCow);

    // Supplement Required
    let supp = 0;
    if (cows > 0) {
        supp = (preGrazeTarget - actualPre) * areaDay / cows;
    }
    document.getElementById('res-supp').innerText = supp.toFixed(1);

    renderFeedWedge(manualModeData, preGrazeTarget, residual);
}
function saveToCloud() { /* ... */ }

</script>
</body>
</html>
